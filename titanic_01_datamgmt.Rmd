---
title: "Kaggle - Titanic"
subtitle: "Step 1: Data Management"
author: "Michael Foley"
date: "4/27/2020"
output: 
  html_document:
    theme: flatly
    toc: true
    highlight: haddock
    fig_width: 9
    fig_caption: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The [Titanic: Machine Learning from Disaster](https://www.kaggle.com/c/titanic) competition challenges participants to predict the survivorship (1 = survived, 0 = perished) of passengers aboard the April 1912 maiden voyage of the Titanic.  In total, 1,502 of the 2,224 passengers and crew perished (68%). The training (*n* = 891) and test (*n* = 418) data sets comprise only a fraction (59%) of the total. The data includes 10 features. Competitors build a predictive model with the training data set, then apply the model to the test data set to produce a submission file consisting of `PassengerId` and `Survived` (1|0).  Kaggle evaluates submissions on *accuracy*.

This file handles the data management, EDA, and feature engineering.  I got a lot of ideas from [here](https://www.kaggle.com/mrisdal/exploring-survival-on-the-titanic).


# Setup

```{r message=FALSE}
library(tidyverse)
library(caret)
library(mfstylr)
library(mice)
```


# Load Data

Here are the train/test data set column definitions from [Kaggle](https://www.kaggle.com/c/titanic/data).

Variable | Definition
---|---
PassengerId	| 
Survived | Survival (0 = No, 1 = Yes)
Pclass | Passenger class (1 = 1st, 2 = 2nd, 3 = 3rd)
Name |				
Sex	| 		
Age	|	Passenger age (years)
SibSp	| # of siblings / spouses aboard the Titanic
Parch	| # of parents / children aboard the Titanic
Ticket | Ticket number
Fare | Passenger fare ($s)
Cabin	| Cabin number
Embarked | Port of Embarkation (C = Cherbourg, Q = Queenstown, S = Southampton)

```{r warning=FALSE, message=FALSE}
train <- read_csv("./train.csv") 
test <- read_csv("./test.csv")
full <- bind_rows(train, test)
train_index <- c(1:891)

glimpse(full)
```

# Feature Engineering

At this point, I know the full data set is 1,309 x 12, including 10 feature columns.  How are we with data types and missingness?

```{r}
skimr::skim(full)
```

`Survived`, `Pclass`, `Sex`, and `Embarked` should be factors.

```{r}
full$Survived <- factor(full$Survived)
full$Pclass <- factor(full$Pclass)
full$Sex <- factor(full$Sex)
full$Embarked <- factor(full$Embarked)
```

`Cabin` is 77% null, `Age` is 20% null, and there are 2 nulls for `Embarked` and 1 for `Fare`.  I'll take care of NAs next.

## Impute NA: Embarked

Passengers `Embarked` from three ports (C = Cherbourg, Q = Queenstown, S = Southampton).  Two passengers have `NA`.

```{r}
full %>% filter(is.na(Embarked))
```

They traveled on the same ticket, so probably embarked from the same port.  One way to impute is to profile passengers by port and see which profile they fit best.  I'll profile by passenger class and fare.  These passengers traveled first class and paid $80 for their tickets.

```{r}
plot_prof <- function(hline, subtitle){
  full %>%
    ggplot(aes(x = Embarked, y = Fare, color = Pclass)) + 
    geom_boxplot(na.rm = TRUE) +
    geom_hline(yintercept = hline, linetype = 2) +
    scale_y_continuous(labels = scales::dollar) +
    theme_mf() +
    scale_color_brewer(palette = "Paired") +
    labs(
      y = "Fare",
      title = "Passenger Profiles",
      subtitle = subtitle
    )
}
plot_prof(80, "First Class passengers paying $80/ticket probably embarked from Cherbourg")
```

Seems like port Cherbourg is a good guess, but it could be any of them.  What does `mice()` say?

```{r}
set.seed(2020)
mice_obj <- mice(
  full[, !names(full) %in% c("PassengerId", "Name", "Ticket", "Cabin")],
  method = "rf"
)
mice_cmpl <- complete(mice_obj)
mice_cmpl[c(62, 830), ] %>% select(Embarked, everything())
```

`mice()` thinks Southampton!  Okay, Southampton it is.

```{r}
full$Embarked <- mice_cmpl$Embarked
```


## Impute NA: Fare

One passenger has no listed fare.

```{r}
full %>% filter(is.na(Fare))
```

`PassengerId` 1044 was a third-class traveler from Southampton.  Let's consult the profile again.

```{r}
med <- full %>% filter(Embarked == "S" & Pclass == 3) %>% select(Fare) %>% 
  map(median, na.rm = TRUE) %>% unlist()
plot_prof(
  med, 
  paste0("Median fare for Southampton third class is ", scales::dollar(med), ".")
)
```

The median fare for Southampton third-class was $8.05.  What did `mice()` say?

```{r}
mice_cmpl[1044, ] %>% select(Fare, everything())
```

$9.22 is reasonably close to $8.05, and I trust MICE more than MIKE, so let's go with that.

```{r}
full$Fare <- mice_cmpl$Fare
```


## Impute NA: Age

20% of passengers have no listed `Age`.  I have no good ideas for imputation, so I'll just go with mice.

```{r}
data.frame(full = full$Age, mice = mice_cmpl$Age) %>%
  pivot_longer(cols = c("full", "mice"), names_to = "Data", values_to= "Age") %>%
  ggplot(aes(x = Age, color = Data)) + 
  geom_density(na.rm = TRUE) +
  theme_mf() +
  labs(title = "Age Distribution", color = "")
```

Mice looks great.

```{r}
full$Age <- mice_cmpl$Age
```


## Name -> Surname, Title, Name

`Name` includes a title and surname.  The title may be predictive of survivorship.  The surname may be useful for constructing family units (do families sink or swim together?), but I'm not sure how to go about doing that, so I'll focus on title.  I learned from other analyses, and supported by [Encycolpedia Titanica](https://www.encyclopedia-titanica.org/titanic-deckplans/), that the first letter of the cabin refers to the deck.  I'll parse these two fields first.

Separate `Name` into `Surname`, `Title`, `Name`.

```{r}
full <- full %>% 
   separate(Name, ", ", into = c("Surname", "Name")) %>%
   separate(Name, "\\. ", into = c("Title", "Name"), extra = "merge")

full %>% count(Title, sort = TRUE) 
```

There are 18 titles. If I turn them all into dummies, most will have near-zero variance.  From the documentation in `caret::nearZeroVar()`, a near zero var is one that is <10% unique and the frequency ratio to the second-most common value is > 95/5 = 19.  For dummy vars, the second-most common value is just the negation, so I can easily calculate both these metrics.

```{r}
check_nzv <- function(dat, col) {
  dat %>% count(!!sym(col), sort = TRUE) %>%
    mutate(
      unique = round(n / sum(n), 2),
      ratio = n / (sum(n) - n),
      ratio = round(if_else(ratio < 1, 1 / ratio, ratio), 0),
      nzv = if_else(unique < 0.10 & ratio > 19, "Yes", "No")
    )
}
full %>% check_nzv("Title")
```

Only the first 3 have-non-zero variance.  "Master" nearly makes the cut.  The top 4 comprise 98% of the rows.  "Mlle" (mademoiselle) and "Ms" both mean "Miss".  "Mme" means "Mrs".  I'll merge these synonyms.  The rest can go into "Other".

```{r}
full <- full %>%
  mutate(
    Title = case_when(
      Title %in% c("Mlle", "Ms") ~ "Miss",
      Title == "Mme" ~ "Mrs",
      Title %in% c("Miss", "Mrs", "Mr", "Master") ~ Title,
      TRUE ~ "Other"
    ),
    Title = parse_factor(Title)
  )
full %>% check_nzv("Title")
```

So basically this variable classifies men, women, boys, and girls. (I wonder how valuable that is given the `Sex` and `Age` variables already in the data set).  `Surname` has 875 unique values, so the average party size is a little less than 2.  Not sure what I can do with `Surname`.

```{r}
n_distinct(full$Surname)
```

## Cabin -> Deck

`Cabin` contains both the deck [A-G, T] (T = Tank Top?) and cabin number (deck descriptions [here](https://jamescameronstitanic.fandom.com/wiki/Titanic_Decks)).  There are a few rows with multiple cabins, and in a few of these instances the multiple cabins are on multiple decks.  

```{r}
unique(full$Cabin)
```

I will asssume the *first* listed cabin contains the deck number.

```{r}
full$Deck <- map_chr(full$Cabin, str_sub, start = 1, end = 1) %>% factor()
addmargins(table(full$Deck, full$Pclass, useNA = "ifany"))
```

There are 8 decks listed. One fellow seems to have been assigned to the tank top, meaning he's sleeping with the ship boilers.  

```{r}
full %>% filter(Deck == "T")
```

First class passenger too - that seems wrong.  What else... The decks are labeled in descending level above water, so the highest deck is "A" and it would have been the most exclusive.  Let's verify that.

```{r}
full %>% count(Deck, Pclass) %>%
  ggplot(aes(x = Deck, y = n, fill = fct_rev(as.factor(Pclass)))) + geom_col() +
  scale_fill_brewer(palette = "Paired") +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(title = "Passengers by Deck", fill = "Class")
```

Decks A-C are all first-class passengers, D has a few second-class, etc.  Makes sense (except for our first class passenger sleeping with the ship boilers).  Lots of nulls.  Seems like a good guess that the third-class passengers are on deck F or G.  How about average ticket fare by deck?

```{r}
full %>% group_by(Deck, Pclass) %>% 
  summarize(n = n(), mean_fare = mean(Fare, na.rm = TRUE)) %>%
  ggplot(aes(x = Deck, y = mean_fare, color = fct_rev(as.factor(Pclass)), size = n)) +
  geom_jitter() +
  scale_fill_brewer(palette = "Paired") +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(title = "Mean Ticket Price by Deck", color = "Class")
```

Looks like deck A was pretty good value.  I better look into that more closely.

```{r}
full %>% filter(Deck == "A") %>% select(-Survived, -Surname, -Name, -Ticket, -Cabin)
```

Nothing unusual, except that Passenger ID 807's fair was $0.  Anyone else with $0 fare?

```{r}
full %>% filter(Fare == 0)
```

17 passengers with $0 fare.  All were male. Of the 15 in the training set, 14 perished.  Passenger class varied from 1 - 3.  All embarked from Southampton.  Could they have been crew?

Okay, so what am I going to do with this columnn?  First, I'll un-assign the deck from Mr. Tank Top since that just seems wrong, and I can't have a factor variable level with one row.  Then I'll let mice impute the NAs.  After that, I'll decide if I should collapse factors F and G since G was pretty sparse. Also, I think the $0 fare is interesting, so I'm going to look into that too.

```{r}
full[340, ]$Deck <- NA
full$Deck = fct_drop(full$Deck)

set.seed(2020)
mice_obj <- mice(
  full[, !names(full) %in% c("PassengerId", "Name", "Ticket", "Cabin")],
  method = "rf"
)
mice_cmpl <- complete(mice_obj)
```

```{r}
addmargins(table(mice_cmpl$Deck, mice_cmpl$Pclass, useNA = "ifany"))
```

Deck G is still sparse, so let's go ahead and collapse the level into F.

```{r}
full$Deck <- mice_cmpl$Deck
full$Deck <- fct_collapse(full$Deck, F = "G")
addmargins(table(full$Deck, full$Pclass, useNA = "ifany"))
```

Oh, where did Mr. Tank Top go?

```{r}
full %>% filter(PassengerId == 340)
```

Deck B!  I feel better about that assignment.


## Fare

17 passengers paid $0 for their ticket.  What is the distribution of fares?

```{r}
full %>%
  ggplot(aes(x = Fare, color = Survived)) + 
  geom_density(na.rm = TRUE) +
  theme_mf() +
  labs(title = "Fare Distribution", color = "")
```

Most people paid under $100.  And the relationship between `Fare` and `Survived`?

```{r}
full[train_index, ] %>%
  mutate(bin = cut(Fare, breaks = 10)) %>%
  count(bin, Sex, Survived) %>%
  ungroup() %>%
  group_by(bin, Sex) %>%
  mutate(Pct = if_else(Survived == 1, n / sum(n), as.numeric(NA))) %>%
  ggplot(aes(x = bin, y = n, fill = Survived, label = scales::percent(Pct, accuracy = 1))) +
  geom_col(position = position_stack()) +
  geom_text() +
  scale_fill_brewer(palette = "Paired") +
  labs(title = "Survivorshp by Fare", x = "Fare") +
  facet_wrap(~ Sex, nrow = 2)
```

Survivorship increases with ticket price with a level effect for females, but the relationship is not linear.  Look more logarithmic.

```{r}
full[train_index, ] %>%
  mutate(bin = cut(log(Fare+.01), breaks = 10)) %>%
  count(bin, Sex, Survived) %>%
  ungroup() %>%
  group_by(bin, Sex) %>%
  mutate(Pct = if_else(Survived == 1, n / sum(n), as.numeric(NA))) %>%
  ggplot(aes(x = bin, y = n, fill = Survived, label = scales::percent(Pct, accuracy = 1))) +
  geom_col(position = position_stack()) +
  geom_text() +
  theme(legend.position = "top") +
  scale_fill_brewer(palette = "Paired") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  labs(title = "Survivorshp by log(Fare)", x = "Log(Fare)") +
  facet_wrap(~ Sex, nrow = 2)
```

Okay, I will transform `Fare` to `logFare`.

```{r}
full$logFare <- log(full$Fare+.01)
```


## Family structure

The number of siblings plus spouse on board, `SibSp`, and number of parents and children on board, `Parch` present interesting possibilities.  Does party size improve survival odds?  Would a husband and wife fair better with or without a child present?  

### Family Size

```{r fig.height=6.5}
full[train_index, ] %>%
  mutate(fam_size = SibSp + Parch + 1) %>%
  count(Title, fam_size, Survived) %>%
  ungroup() %>% 
  group_by(Title, fam_size) %>%
  mutate(Pct = if_else(Survived == 1, n / sum(n), as.numeric(NA))) %>%
  ggplot(aes(x = fam_size, y = n, fill = as.factor(Survived), label = scales::percent(Pct))) + 
  geom_col() +
  geom_text(size = 3, na.rm = TRUE) +
  scale_fill_brewer(palette = "Paired") +
  scale_x_discrete(limits = c(1:11)) +
  theme(legend.position = "top") +
  labs(title = "Survival by Family Size", fill = "Survived") +
  facet_wrap(~Title, nrow = 3)
```

I'll make family size a factor variable with bins 1, 2, and 3+

```{r}
full <- full %>%
  mutate(Fsize = factor(if_else(SibSp + Parch + 1 >=3, 3, SibSp + Parch + 1)))
```


### Role (Mom, Dad, Son, etc.)

```{r}
full <- full %>%
  mutate(
    Role = case_when(
      Sex == "female" & Age > 50 & Parch >= 1 ~ "Grandmother",
      Sex == "female" & Age >= 20 & Age <= 50 & Parch >= 1 ~ "Mother/Wife",
      Sex == "female" & Age < 20 & Parch >= 1 ~ "Daughter",
      Sex == "female" & Fsize == 2 ~ "Mother/Wife",
      Sex == "male" & Age > 50 & Parch >= 1 ~ "Grandfather",
      Sex == "male" & Age >= 20 & Age <= 50 & Parch >= 1 ~ "Father/Husb",
      Sex == "male" & Age < 20 & Parch >= 1 ~ "Son",
      Sex == "male" & Fsize == 2 ~ "Father/Husb",
      Fsize == 3 ~ "Group",
      TRUE ~ "Alone"
    ),
    Role = factor(Role)
  )
```

```{r}
full[train_index, ] %>%
  count(Role, Survived) %>%
  ungroup() %>%
  group_by(Role) %>%
  mutate(Pct = if_else(Survived == 1, n / sum(n), as.numeric(NA))) %>%
  ggplot(aes(x = Role, y = n, fill = Survived, label = scales::percent(Pct))) +
  geom_col() +
  scale_fill_brewer(palette = "Paired") +
  geom_text() +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme_mf() +
  theme(axis.text.x = element_text(size = 9))
```


## Remove Vars

The text fields are the chaffe, so discard them.

```{r}
full <- full %>% 
  select(-Surname, -Name, -Ticket, -Cabin, -Fare) %>%
  select(PassengerId, Survived, sort(names(.))) 
```

One final look.

```{r}
skimr::skim(full)
```

# Save Work

```{r}
save(full, train_index, file = "./titanic_01.RData")
```

