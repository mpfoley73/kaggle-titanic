---
title: "Kaggle - Titanic"
subtitle: "Step 1: Data Management"
author: "Michael Foley"
date: "4/27/2020"
output: 
  html_document:
    theme: flatly
    toc: true
    highlight: haddock
    fig_width: 9
    fig_caption: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The [Titanic: Machine Learning from Disaster](https://www.kaggle.com/c/titanic) competition challenges participants to predict the survivorship (1 = survived, 0 = perished) of passengers aboard the April 1912 maiden voyage of the Titanic.  In total, 1,502 of the 2,224 passengers and crew perished (68%). The training (*n* = 891) and test (*n* = 418) datasets comprise only a fraction of the total (59%). The data includes 10 features. Competitors build a predictive model with the training dataset, then apply the model to the test dataset to produce a submission file consisting of `PassengerId` and `Survived` (1|0).  Kaggle evaluates submissions on *accuracy*.

This file handles the data management, EDA, and feature engineering.  I got a lot of ideas from [here](https://www.kaggle.com/mrisdal/exploring-survival-on-the-titanic).


# Setup

```{r message=FALSE}
library(tidyverse)
library(caret)
library(mfstylr)
```


# Load Data

Here are the [column definitions](https://www.kaggle.com/c/titanic/data) in the dataset:

Variable | Definition
---|---
PassengerId	| 
Survived | Survival (0 = No, 1 = Yes)
Pclass | Passenger class (1 = 1st, 2 = 2nd, 3 = 3rd)
Name |				
Sex	| 		
Age	|	Passenger age (years)
SibSp	| # of siblings / spouses aboard the Titanic
Parch	| # of parents / children aboard the Titanic
Ticket | Ticket number
Fare | Passenger fare ($s)
Cabin	| Cabin number
Embarked | Port of Embarkation (C = Cherbourg, Q = Queenstown, S = Southampton)

```{r warning=FALSE, message=FALSE}
train <- read_csv("./train.csv") 
test <- read_csv("./test.csv")
full <- bind_rows(train, test)
train_index <- c(1:891)

glimpse(full)
```


# Feature Engineering

At this point, I know the full dataset is 1,309 x 12, including 10 feature columns.  How are we with data types and missingness?

```{r}
skimr::skim(full)
```

Cabin is 78% `NA`, `Age` is 20% `NA`, and there is 2 `NA` for `Embarked` and 1 `NA` for `Fare`.

## Impute NA: Embarked

Passengers `Embarked` from three ports (C = Cherbourg, Q = Queenstown, S = Southampton).  Two passengers have `NA`.

```{r}
full %>% filter(is.na(Embarked))
```

Both traveled without parents or siblings, so we can't try to pair them up with anyone.  We could guess by passenger class and fair.  Both were first class passengers, paying $80 for cabin B28.

```{r}
full %>% filter(Cabin == "B28")
```

```{r}
full %>%
  ggplot(aes(x = as.factor(Pclass), y = Fare, color = Embarked)) + geom_boxplot() +
  labs(title = "Embarked by Fare and Class")
```

Seems like port `C` is a good guess.

```{r}
full$Embarked <- replace_na(full$Embarked, "C")
```


## Name -> Surname, Title, Name


`Name` includes a title and surname.  The title may be predictive of survivorship.  The surname may be useful for constructing family units (do families sink or swim together?).  I learned from other analyses, and supported by [Encycolpedia Titanica](https://www.encyclopedia-titanica.org/titanic-deckplans/), that the first letter of the cabin refers to the deck.  I'll parse these two fields first.

Separate `Name` into `Surname`, `Title`, `Name`.

```{r}
full <- full %>% 
   separate(Name, ", ", into = c("Surname", "Name")) %>%
   separate(Name, "\\. ", into = c("Title", "Name"), extra = "merge")

full %>% count(Title, sort = TRUE) 
```

There are 18 titles. If I turn them all into dummies, most will have near-zero variance.  From the documentation in `caret::nearZeroVar()`, a near zero var is one that is <10% unique and the frequency ratio to the second-most common value is > 95/5 = 19.  For dummy vars, the second-most common value is just the negation, so I can calculate both these metrics for Title's values.

```{r}
check_nzv <- function(dat, col) {
  dat %>% count(!!sym(col), sort = TRUE) %>%
    mutate(
      unique = round(n / sum(n), 2),
      ratio = n / (sum(n) - n),
      ratio = round(if_else(ratio < 1, 1 / ratio, ratio), 0),
      nzv = if_else(unique < 0.10 & ratio > 19, "Yes", "No")
    )
}
full %>% check_nzv("Title")
```

Only the first 3 have-non-zero variance.  "Master" nearly makes the cut.  The top 4 comprise 98% of the rows.  "Mlle" (mademoiselle) and "Ms" both mean "Miss".  "Mme" means "Mrs".  I'll merge these synonyms.  The rest can go into "Other".

```{r}
full <- full %>%
  mutate(
    Title = case_when(
      Title %in% c("Mlle", "Ms") ~ "Miss",
      Title == "Mme" ~ "Mrs",
      Title %in% c("Miss", "Mrs", "Mr", "Master") ~ Title,
      TRUE ~ "Other"
    ),
    Title = parse_factor(Title)
  )
full %>% check_nzv("Title")
```

So basically this variable classifies men, women, boys, and girls. I wonder how valuable that is given the `Sex` and `Age` variables already in the datas set.  `Surname` has 875 unique values, so the average party size is a little less than 2.  Not sure what I can do with `Surname`.

```{r}
n_distinct(full$Surname)
```

## Cabin -> Deck

`Cabin` contains both the deck [A-G] + [T] (Tank Top?) and cabin number (deck descriptions [here](https://jamescameronstitanic.fandom.com/wiki/Titanic_Decks)).  There are a few examples of multiple cabins, and in a few of these instances the multiple cabins are on multiple decks.  

```{r}
unique(full$Cabin)
```

I will asssume the first listed cabin contains the deck number.

```{r}
full$Deck <- map_chr(full$Cabin, str_sub, start = 1, end = 1)
table(full$Deck)
```

There are 8 decks listed. One fellow seems to have been assigned to the tank top, meaning he's sleeping with the ship boilers.  

```{r}
full %>% filter(Deck == "T")
```

First class passenger too - that seems wrong.  The decks are labeled in descending level above water, so the highest deck is "A" and it would have been the most exclusive.  Let's verify that.

```{r}
full %>% count(Deck, Pclass) %>%
  ggplot(aes(x = Deck, y = n, fill = fct_rev(as.factor(Pclass)))) + geom_col() +
  scale_fill_brewer(palette = "Paired") +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(title = "Passengers by Deck", fill = "Class")
```

Decks A-C are all first-class passengers, D has a few second-class, etc.  Makes sense (except for our first class passenger sleeping with the ship boilers).  Lots of nulls.  Seems like a good guess that the third-class passengers are on deck F or G.  How about average ticket fare by deck?

```{r}
full %>% group_by(Deck, Pclass) %>% 
  summarize(n = n(), mean_fare = mean(Fare, na.rm = TRUE)) %>%
  ggplot(aes(x = Deck, y = mean_fare, color = fct_rev(as.factor(Pclass)), size = n)) +
  geom_jitter() +
  scale_fill_brewer(palette = "Paired") +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(title = "Mean Ticket Price by Deck", color = "Class")
```

Looks like deck A was pretty good value.  I better look into that more closely.

```{r}
full %>% filter(Deck == "A") %>% select(-Survived, -Surname, -Name, -Ticket, -Cabin)
```

Nothing unusual, except that Passenger ID 807's fair was $0.  Anyone else like that?

```{r}
full %>% filter(Fare == 0) %>% count()
skimr::
```

Hmm, kind of a lot.  

If I turn them all into dummies, most will have near-zero variance.  From the documentation in `caret::nearZeroVar()`, a near zero var is one that is <10% unique and the frequency ratio to the second-most common value is > 95/5 = 19.  For dummy vars, the second-most common value is just the negation, so I can calculate both these metrics for Title's values.

```{r}
check_nzv <- function(dat, col) {
  dat %>% count(!!sym(col), sort = TRUE) %>%
    mutate(
      unique = round(n / sum(n), 2),
      ratio = n / (sum(n) - n),
      ratio = round(if_else(ratio < 1, 1 / ratio, ratio), 0),
      nzv = if_else(unique < 0.10 & ratio > 19, "Yes", "No")
    )
}
full %>% check_nzv("Title")
```

Only the first 3 have-non-zero variance.  "Master" nearly makes the cut.  The top 4 comprise 98% of the rows.  "Mlle" (mademoiselle) and "Ms" both mean "Miss".  "Mme" means "Mrs".  I'll merge these synonyms.  The rest can go into "Other".

```{r}
full <- full %>%
  mutate(
    Title = case_when(
      Title %in% c("Mlle", "Ms") ~ "Miss",
      Title == "Mme" ~ "Mrs",
      Title %in% c("Miss", "Mrs", "Mr", "Master") ~ Title,
      TRUE ~ "Other"
    )
  )
full %>% check_nzv("Title")
```

```{r}
# Out of curiosity, what are the unique cabins?
str_split(full$Cabin, " ") %>% unlist() %>% unique() %>% .[!is.na(.)] %>% sort()

# Extract Deck
full$Deck <- map_chr(str_extract_all(full$Cabin, "[A-Z]"), function(.decks_list) {
  paste0(unique(.decks_list), collapse = ",")
}) %>% "[<-"(., . == "NA", NA)

# How is Deck distributed?
d %>% filter(Set == "Train") %>% tabyl(Deck) %>% adorn_pct_formatting() %>% arrange(desc(n))

# Convert Deck to factor and combine levels F, "F,E" and "F,G" (because they are all on Deck F)
d$Deck <- 
  parse_factor(d$Deck) %>% 
  fct_explicit_na() %>% 
  fct_collapse(`F` = c("F", "F,E", "F,G"))

d %>% filter(Set == "Train") %>% tabyl(Deck) %>% adorn_pct_formatting() %>% arrange(desc(n))

# How is survival rate affected by Deck (after consolidating sparse levels)?
d %>% 
  filter(Set == "Train") %>%
  mutate(Survived = recode_factor(Survived, Y = "Lived", N = "Died"),
         Deck = fct_lump(Deck, 5)) %>%
  count(Deck, Survived) %>%
  pivot_wider(names_from = Survived, values_from = n, values_fill = list(n = 0)) %>%
  mutate(SurvivalRate = round(Lived/(Lived + Died), 2),
         `% Total` = (Lived + Died)/nrow(d.train)) %>%
  arrange(desc(SurvivalRate))

#' ### Consolidate levels
# Decks B, E, and D have similar survival rates.  Let's combine these and merge C into Other.
d$Deck <- fct_collapse(d$Deck, B_E_D = c("B", "E", "D")) %>% fct_lump(n = 2)

d %>%
  filter(Set == "Train") %>%
  tabyl(Deck, Survived) %>%
  adorn_percentages() %>%
  adorn_pct_formatting() %>%
  adorn_ns() %>% 
  mutate(SurvivalRate = (attr(., "core") %>% pull(Y)) / ((attr(., "core") %>% pull(Y)) + (attr(., "core") %>% pull(N))),
         `% Total` = (attr(., "core") %>% pull(N) + attr(., "core") %>% pull(Y)) / nrow(d.train)) %>%
  mutate_at(vars(SurvivalRate, `% Total`), round, 2) %>%
  `names<-`(c("Deck", "Died", "Lived", "SuvivalRate", "% Total"))

# Use a mosaic plot to visualize separation
mosaicplot(data = d, Deck ~ Survived, color = T, main = NULL)

# So there seems to be good separation with each level composing at least 10% of the training data.
# Maybe this is because survivors were able to tell their stories, including what cabin they were in?
```


## Family structure

The number of siblings plus spouse on board `SibSp`, and number of children and parents on board `Parch` present interesting possibilities.  Does party size improve survival odds?  Would a husband and wife fair better with or without a child present?  

```{r}
full[train_index, ] %>%
  mutate(fam_size = SibSp + Parch + 1) %>%
  count(Title, fam_size, Survived) %>%
  ggplot(aes(x = fam_size, y = n, fill = as.factor(Survived))) + 
  geom_col() +
  scale_fill_brewer(palette = "Paired") +
  scale_x_discrete(limits = c(1:11)) +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(title = "Survival by Title", fill = "Survived") +
  facet_wrap(~Title, nrow = 1)
```




```{r}
skimr::skim(full)
```

`Name` is never `NA`.  Curious that there are only 1307 unique names among the 1309 rows. I guess that can happen.

```{r}
full %>% count(Name, sort = T) %>% head()
full %>% filter(Name %in% c("Connolly, Miss. Kate", "Kelly, Mr. James")) %>% arrange(Name)
```

```{r}
unique(full$Sex)
```


# Manage Data



```{r}

```




# Create Test and Train




# Save Work

```{r}
#save(d_raw_1, 
#     file = "./titanic_01.RData")
```

