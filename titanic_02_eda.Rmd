---
title: "Kaggle - Titanic"
subtitle: "Step 2: Exploratory Analysis"
author: "Michael Foley"
date: "5/7/2020"
output: 
  html_document:
    theme: flatly
    toc: true
    highlight: haddock
    fig_width: 9
    fig_caption: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This is a survey of the Titanic data.  The univariate analysis characterizes the predictor distributions.  The bivariate analysis characterizes relationships among the predictors and with the response variable.  The influential outliers analysis searches for problematic observations.  

Conclusions:

* Factor variables `Employee`, `Deck.A`, and `Title.Master` have near-zero-variance.

* Nearly all of the quantitative predictors suffer from skew.  It may make sense to transform these variables in modeling, especially for linear regression models.

* `Sex` is by the far the best predictor of survival.  `Title` is second, but recall that it basically combines sex and age. `Pclass` is third. 

* Define an `AgeCohort` predictor for age bins (<16, 16-48, >48).  For linear models, `AgeCohort` should interact with `Age` and `Sex` as `Age*Sex*AgeCohort`. Linear models may also benefit from an interaction between `Sex` and `FamSize`, and between `Sex` and `NetSurv`.


# Setup

```{r message=FALSE}
library(tidyverse)
library(caret)  # for nearZeroVar()
library(e1071)  # for skewness()
library(broom)  # for tidy()
library(GGally) # for ggpairs()
library(gridExtra) 
library(janitor)
```


# Load Data

The initial data management created the data set `full`, with training rows indexed by `train_index`.

```{r warning=FALSE, message=FALSE}
load("./titanic_01.RData")

glimpse(full)
```

# Univariate Analysis

In this section I will look at data distributions. For factor variables, I am interested in which have near-zero-variance. For quantitative variables, I am looking for significant skew. 

It will be handy to classify the predictors by data type.

```{r}
preds <- full %>% 
  select(-Survived, -PassengerId, -Surname, -Name, -Ticket, -Cabin, -Fare) %>% 
  colnames()
preds_class <- full[, preds] %>% map(class) %>% unlist()
preds_factor <- subset(preds_class, preds_class == "factor") %>% names()
preds_numeric <- subset(preds_class, preds_class %in% c("numeric", "integer")) %>% names()
mdl_vars <- c("Survived", preds)
rm(preds_class)

assertthat::are_equal(length(c(preds_factor, preds_numeric)), length(preds))
```

## Factor Variables

Inspect each factor variable, looking for near-zero-variance (NZV). I might collapse them to prevent zero-variance in CV folds. `caret::nearZeroVar()` defines NZV as a frequency ratio of the most common value to the second most common value frequency >= 19/5 and a unique value percentage <= 10%. (*DataCamp course Machine Learning Toolbox suggests more aggressive thresholds of frequency ratio >= 2 and unique value percentage <= 20%*).

```{r warning=FALSE}
dummies <- dummyVars(~., data = full[, preds_factor], fullRank = FALSE)
dummy_dat <- as.data.frame(predict(dummies, full[, preds_factor]))
(nzv <- dummy_dat %>%
    nearZeroVar(saveMetrics= TRUE)
)
```

The problematic predictors are `Title`, `Employee`, and `Deck = "A"`. 

Here is a visualization of the data. Ideally, you want the vars to land in the top left quadrant.  NZV are in the lower right quadrant.

```{r}
nzv %>%
  data.frame() %>% rownames_to_column(var = "col") %>%
  separate(col, sep = "\\.", into = c("col", "level"), ) %>%
  filter(!is.na(level)) %>%
  ggplot(aes(x = freqRatio, y = percentUnique, 
             color = fct_rev(factor(nzv, labels = c("(okay)", "NZV"))), 
             label = level)) +
  geom_text(check_overlap = TRUE, size = 2, na.rm = TRUE) +
  geom_point(size = 3, alpha = 0.6, na.rm = TRUE) +
  geom_hline(yintercept = 10, linetype = "dashed") +
  geom_vline(xintercept = 95/5, linetype = "dashed") +
  theme(legend.position = "top") +
  labs(title = "Near-Zero Variance of Factor Variables", color = "") +
  facet_wrap(~col)

rm(dummies, dummy_dat, nzv)
```


## Quantitative Variables

Skew can contribute to violation of linearity in linear regressions. Iâ€™ll check which variables have significant skew. Skew between 0.5 and 1.0 is generally considered moderate, and skew greater than 1 severe. In the following charts, negligibly skewed predictors are colored theil (there are none), moderately skewed predictors are colored gold and the severely skewed predictors are colored red.

```{r message=FALSE}
col_skew <- map(full[, preds_numeric], skewness) %>% unlist()
col_skew_is_mod <- names(col_skew[abs(col_skew) > .5 & abs(col_skew) <= 1.0])
col_skew_is_high <- names(col_skew[abs(col_skew) > 1.0])
p <- map(
  colnames(full[, preds_numeric]),
  ~ ggplot(full, aes_string(x = .x)) +
    geom_histogram(fill = case_when(.x %in% col_skew_is_mod ~ "goldenrod", 
                                    .x %in% col_skew_is_high ~ "orangered4",
                                    TRUE ~ "cadetblue")) +
    labs(y = "", x = "", title = .x) +
    theme(axis.text.y=element_blank(), plot.title = element_text(size = 10))
)
exec(grid.arrange, ncol = 2, !!!p)

rm(col_skew, col_skew_is_high, col_skew_is_mod)
```

Nearly all of the quantitative predictors suffer from skew.  It may make sense to transform these variables in modeling.

# Bivariate Analysis

In this section I will look at inter-variable relationships. For factor variables, I am interested in which levels have significantly different log survival odds. For quantitative variables, I am looking for linear relationships with log survival odds and low correlations with each other.  I am also interested in any variable interactions that might improve the linearity assumptions of linear models.

Conclusions:

* `Sex` moderates `Pclass`, `Title`, `Embarked`, and `FamSize`.
* `Deck` has very little separation among the levels - collapse it?


Before I begin, let's get some initial perspective which variables are correlated with survival.

```{r cache=TRUE, warning=FALSE}
dummies_fullrank <- dummyVars(~., data = full[, mdl_vars], fullRank = TRUE)
full_dum <- as.data.frame(predict(dummies_fullrank, full[, mdl_vars]))

cor_out <- full_dum[train_index, ] %>% cor()
cor_out[, "Survived.Yes"] %>% abs() %>% sort(decreasing = TRUE) %>% head(11)
```
 
`Title` and `Sex` are by the far the best predictors of survival (`Title` basically combines sex and age). `Pclass` and `FarePerPass` are next.  Embarkation port is also important. So far it seems your best bet for survival is to be a rich woman.

For this analysis I'll define a plotting function with a logistic regression fit.

```{r}
model_bin <- function(dat, fmla) {
  mdl <- train(
    as.formula(fmla),
    dat,
    method = "glm", family = "binomial",
    metric = "Accuracy",
    trControl = trainControl(method = "cv", n = 10)      
  )
}

plot_bin <- function(dat, x_var, facet_var, fmla) {
  dat %>% 
    group_by(!!sym(x_var), !!sym(facet_var), Survived, pred) %>%
    summarize(n = n()) %>%
    pivot_wider(names_from = "Survived", values_from = n, names_prefix = "Survived.") %>%
    replace_na(list(Survived.No = 0, Survived.Yes = 0)) %>%
    mutate(
      N = Survived.No + Survived.Yes,
      prop = Survived.Yes / N,
      odds = prop / (1 - prop),
      log_odds = log(odds),
      log_odds = case_when(log_odds == -Inf ~ -3, 
                           log_odds ==  Inf ~  3, 
                           TRUE ~ log_odds),
      pred_log_odds = log(pred / (1 - pred))
    ) %>%
    ggplot(aes(x = !!sym(x_var))) +
      geom_point(aes(y = log_odds, size = N, color = "Actual"), alpha = 0.6) +
      geom_point(aes(y = pred_log_odds, color = "Predicted")) +
      scale_color_manual(values = c("cadetblue", "goldenrod")) +
      theme(axis.text.x = element_text(angle = 90)) +
#      scale_y_continuous(limits = c(-3.5, 3.5)) +
      labs(title = fmla, x = x_var, color = "") +
      facet_wrap(facets = facet_var)
}
```


## Sex

In the training data set, 19% of males survived and 74% of the females survived.  We should get 74-81% accuracy just by predicting all males perish and all females survive.

```{r}
tabyl(full[train_index, ], Sex, Survived) %>%
  adorn_totals(where = c("row", "col")) %>%
  adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns() %>%
  adorn_title("combined") %>%
  knitr::kable()
```


## Age

Here is the survival log-odds for `Age`.  Children of both sexes had relatively good survival odds.  For males, the children reverse a generally positive relationship with age.  The female relationship seems okay.

```{r}
fmla <- "Survived ~ Sex*Age"
dat <- full[train_index, ] %>% mutate(age_bin = cut(Age, 16))
mdl <- dat %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "age_bin", facet_var = "Sex", fmla = fmla)
```

So maybe there should be an `AgeCohort = c(lte10, gt10)` factor variable that moderates `Age`.

```{r}
fmla <- "Survived ~ Sex*Age*AgeCohort"
dat <- full[train_index, ] %>% 
  mutate(
    AgeCohort = factor(if_else(Age <= 10, "lte10", "gt10")),
    AgeBin = cut(Age, 16)
  )
mdl <- dat %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "AgeBin", facet_var = "Sex", fmla = fmla)
```
Better.  I'll create the `AgeCohort` predictor and plan to interact it with `Age` and `Sex` since the slopes differ.

```{r}
full <- full %>%
  mutate(AgeCohort = factor(if_else(Age <= 10, "lte10", "gt10"), 
                            levels = c("lte10", "gt10")))
```

## Title

Title is closely related to `Sex` and `Age`.  Is it still useful?  

Here is the sex/age breakdown. 53-54% of children survive (same for males and females). Over age 10, 17% of males survive and 77% of females survive.

```{r}
full[train_index, ] %>% 
  tabyl(AgeCohort, Survived, Sex) %>%
  adorn_totals(where = c("row", "col")) %>%
  adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns() %>%
  adorn_title("combined") %>%
  knitr::kable()
```

Combining `AgeCorhort` and `Title`, 34/40 "Master" are under age 10, and 515/517 "Mr" are over age 10.  "Miss" has less separation: 147/182 "Miss" are over age 10. I suspect "Miss" means *any* female who has not yet married.

```{r}
full[train_index, ] %>% 
  tabyl(Title, Survived, AgeCohort) %>%
  adorn_totals(where = c("row", "col")) %>%
  adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns() %>%
  adorn_title("combined") %>%
  knitr::kable()
```

So, do passengers with a title other than Master/Miss/Mrs/Mr have a better chance of surviving?  A little: 44% of titled persons survived compared to 38% of untitled.  But only 27/891 = 3% of passengers have a title.

```{r}
full[train_index, ] %>% 
  mutate(HasTitle = if_else(Title %in% c("Mr", "Mrs", "Master", "Miss"), "No", "Yes")) %>%
  tabyl(HasTitle, Survived) %>%
  adorn_totals(where = c("row", "col")) %>%
  adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns() %>%
  adorn_title("combined") %>%
  knitr::kable()
```

I think the conclusion here is that `Title` is redundant to `AgeCohort` and `Sex` and I should not include it in the models.

## Pclass

Third class passengers (`Pclass = 3`) had a rough go of it.  Male survival odds are cut in half when dropping to 2nd class, then stay about the same for 3rd class.  Female survival odds stayed the same for 2nd class, but halved when dropping to 3rd class.  N-size is small for the females though.  Looks like all three classes are important, but should be moderated by `Sex`.

```{r}
fmla <- "Survived ~ Pclass*Sex"
dat <- full[train_index, ]
mdl <- dat %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "Pclass", facet_var = "Sex", fmla = fmla)
```

## TicketN

Traveling with with others helps - but only to a point!  Both male and female survival odds increase with ticket size to n = 4, then they fall.

```{r}
fmla <- "Survived ~ TicketN + Sex"
dat <- full[train_index, ]
mdl <- dat %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "TicketN", facet_var = "Sex", fmla = fmla)
```

How about a dummy variable `TicketNCohort = c("lte4", "gt4")`.

```{r}
fmla <- "Survived ~ TicketN*TicketNCohort + Sex"
dat <- full[train_index, ] %>%
  mutate(TicketNCohort = factor(if_else(TicketN <= 4, "lte4", "gt4")))
mdl <- dat %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "TicketN", facet_var = "Sex", fmla = fmla)
```

Better.  I'll create the `TicketNCohort` predictor and plan to interact it with `TicketN`.

```{r}
full <- full %>%
  mutate(TicketNCohort = factor(if_else(TicketN <= 4, "lte4", "gt4"), 
                            levels = c("lte4", "gt4")))
```


## SibSp

Survival odds fall with increasing numbers of spouse+siblings.  Maybe people made sure at least on child in a family got aboard a raft.  Males traveling with no spouse or sibling is a conspicuously frequent and dubious group. 

```{r}
fmla <- "Survived ~ SibSp + Sex"
dat <- full[train_index, ]
mdl <- full[train_index, ] %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "SibSp", facet_var = "Sex", fmla = fmla)
```

Including the newly-created `TicketNCohort` variable seems to help.

```{r}
fmla <- "Survived ~ SibSp + Sex + TicketN*TicketNCohort"
dat <- full[train_index, ]
mdl <- full[train_index, ] %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "SibSp", facet_var = "Sex", fmla = fmla)
```

No actions need to be taken with this variable - just include it in the model as-is.

## Parch

Survival odds fall with increasing numbers of parents and children.  Again, males traveling alone are in trouble. 

```{r}
fmla <- "Survived ~ Parch + Sex"
dat <- full[train_index, ]
mdl <- full[train_index, ] %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "Parch", facet_var = "Sex", fmla = fmla)
```

Including the newly-created `TicketNCohort` variable seems to help.  Hard to tell, actually.

```{r}
fmla <- "Survived ~ Parch + Sex + TicketN*TicketNCohort"
dat <- full[train_index, ]
mdl <- full[train_index, ] %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "Parch", facet_var = "Sex", fmla = fmla)
```

No actions need to be taken with this variable - just include it in the model as-is.

## Embarked

Embarking from Queenstown was a death sentence for males for some reason.  `Embarked` should interact with `Sex.

```{r}
fmla <- "Survived ~ Embarked*Sex"
dat <- full[train_index, ]
mdl <- dat %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "Embarked", facet_var = "Sex", fmla = fmla)
```

## FarePerPass

Here is the survival log-odds for `FarePerPass`.  I don't really see much of a relationship.  I think the thing to do is to leave the variable along, include it in the model and see what happens.

```{r}
fmla <- "Survived ~ Sex + FarePerPass"
dat <- full[train_index, ] %>% mutate(FarePerPassBin = cut(FarePerPass, 10))
mdl <- dat %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "FarePerPassBin", facet_var = "Sex", fmla = fmla)
```


## Employee
## Deck


Employee has such a small n-size that it may not be a very useful variable. No females were employees.


Generally, it's better to have a cabin on a deck at the top of the alphabet.  No interaction with `Sex`.  Not a lot of separation among the decks, except maybe decks E & F vs others.  Deck A has a very low n-size.  Consider collapsing `Deck`.


Traveling alone was deadly for males, not so much for females.  Good case for an interaction effect.
```{r}
#plot_bv_bar(full[train_index, ], "FamSize")
```


## Survived ~ Numeric Predictor Relationships

There are 18 titles. If I turn them all into dummies, most will have near-zero variance.  From the documentation in `caret::nearZeroVar()`, a near zero var is one that is <10% unique and the frequency ratio to the second-most common value is > 95/5 = 19.  For dummy vars, the second-most common value is just the negation, so I can easily calculate both these metrics.

```{r}
check_nzv <- function(dat, col) {
  dat %>% count(!!sym(col), sort = TRUE) %>%
    mutate(
      unique = round(n / sum(n), 2),
      ratio = n / (sum(n) - n),
      ratio = round(if_else(ratio < 1, 1 / ratio, ratio), 0),
      nzv = if_else(unique < 0.10 & ratio > 19, "Yes", "No")
    )
}
full %>% check_nzv("Title")
```

Only the first 3 have-non-zero variance.  "Master" nearly makes the cut.  The top 4 comprise 98% of the rows.  "Mlle" (mademoiselle) and "Ms" both mean "Miss".  "Mme" means "Mrs".  I'll merge these synonyms.  The remaining items will comprise a very small proportion of values, so even grouping them into "Other" will make the factor NZV.  I'll take some guesses for them.

```{r}
full <- full %>%
  mutate(
    Title = case_when(
      Title %in% c("Mlle", "Ms") ~ "Miss",
      Title == "Mme" ~ "Mrs",
      Title %in% c("Miss", "Mrs", "Mr", "Master") ~ Title,
      Title %in% c("Dr", "Rev", "Major", "Col", "Capt") & Sex == "male" ~ "Mr",
      Title %in% c("Dr") & Sex == "female" ~ "Mrs",
      Title == "Lady" & Age >= 30 ~ "Mrs",
      Title %in% c("Don", "Sir", "Jonkheer") ~ "Mr",
      Title %in% c("the Countess", "Dona") ~ "Mrs",
      TRUE ~ Title
    ),
    Title = parse_factor(Title)
  ) 
full %>% check_nzv("Title")
```

So basically this variable classifies men, women, boys, and girls. (I wonder how valuable that is given the `Sex` and `Age` variables already in the data set).  `Surname` has 875 unique values, so the average party size is a little less than 2.  Not sure what I can do with `Surname`.

```{r}
n_distinct(full$Surname)
```
## Strength in Numbers?

### Family Size
The number of siblings plus spouse on board, `SibSp`, and number of parents and children on board, `Parch` present interesting possibilities.  Does *total* family size improve survival odds? 



In general, survival odds fall with increasing family size, although the n-size is pretty small for families over three.  Men buck the trend a little - their surivorship is relatively low when traveling alone.  I'll make family size a factor variable, `FamSize`, with bins 1, 2, and 3+.  For modeling, it probably makes sense to have an interaction variable for `Title*Fsize`.

```{r}
full <- full %>%
  mutate(
    FamSize = if_else(SibSp + Parch + 1 >=3, 3, SibSp + Parch + 1),
    FamSize = factor(FamSize, levels = c(1, 2, 3), labels = c("1", "2", "gte3"))
  )

full[train_index, ] %>% plot_surv_grp("FamSize", "Title")
```

### Ticket Size

Is there a similar effect for the number of people in the party?

```{r}
full[train_index, ] %>% plot_surv_grp("TicketN", "Title")
```

In general, survival increase until party size of 4, then falls with increasing family size, although the n-size is pretty small for families over three.  Men buck the trend a little - their survivor odds are relatively low when traveling alone.  I'll make family size a factor variable, `Fsize`, with bins 1, 2, and 3+.  For modeling, it probably makes sense to have an interaction variable for `Title*Fsize`.

```{r}
full <- full %>% 
  mutate(
    TktSize = if_else(TicketN >= 4L, 4L, TicketN),
    TktSize = factor(TktSize, levels = c(1, 2, 3, 4), labels = c("1", "2", "3", "gte4"))
  )

full[train_index, ] %>% plot_surv_grp("TktSize", "Title")
```


## Net Survivors

Is the survivorship of the other passengers on the ticket predictive of your survivorship?  Create feature `TicketSurvN`.

```{r}
full <- full %>%
  group_by(Ticket) %>%
  mutate(
    SurvN = sum(Survived == "Yes", na.rm = TRUE),
    PrshN = sum(Survived == "No", na.rm = TRUE)
  ) %>% 
  ungroup() %>%
  mutate(
    SurvN = SurvN - if_else(!is.na(Survived) & Survived == "Yes", 1, 0),
    PrshN = PrshN - if_else(!is.na(Survived) & Survived == "No", 1, 0),
    NetSurv = SurvN - PrshN,
  ) %>%
  select(-SurvN, -PrshN)
```

```{r warning=FALSE, message=FALSE}
plot_net_surv <- function() {
  full[train_index, ] %>%
    group_by(NetSurv, Sex) %>%
    summarize(
      n = n(), 
      log_odds = log(mean(Survived == "Yes") / (1 - mean(Survived == "Yes")))
    ) %>%
    ggplot(aes(x = NetSurv, y = log_odds, color = Sex)) +
    geom_point(aes(size = n)) +
    geom_smooth(se = FALSE, method = "lm") +
    theme_minimal() +
    scale_color_brewer(palette = "Paired") +
    theme(legend.position = "top") +
    labs(title = "Survival log-odds if Others Survive", color = "")
}
plot_net_surv()
```

It certainly does appear to be predictive.  The tails are thinly populated and the linearity breaks down.  I can probably collapse the tails.

```{r}
full[train_index, ] %>% group_by(NetSurv) %>% summarize(n = n(), mean = mean(Survived == "Yes"))
```

I'll collapse bins [-6, -1] and [1, 3].

```{r}
full$NetSurv <- map_dbl(full$NetSurv, max, -1)
full$NetSurv <- map_dbl(full$NetSurv, min, 1)
plot_net_surv()
```


## Numeric Predictor Intervariable Correlations

What are the correlations of the numeric variables with log survival odds?

```{r}

```



Here is a visualization of the relationships.


```{r}
ggpairs(
  full[train_index, c("Survived", preds_numeric)],
  mapping = aes(color = Survived, alpha = 0.02),
  columns = 2:(length(preds_numeric) + 1)
)
```


```{r message=FALSE}
plot_ggpairs <- function(col) {
full[train_index, mdl_vars] %>% 
  ggpairs(
    mapping = aes(color = Survived, alpha = 0.2), 
    columns = c(4, col),
    legend = c(1,1)
  ) +
  theme(legend.position = "top")
}
for(i in c(2, 3, 5:15)) {
  print(plot_ggpairs(i))
}
```


```{r}
plot_bv_box <- function(dat, num_var, color){
  dat %>% 
    ggplot(aes(y = !!sym(num_var)))
}
```

The following tables break down the factor levels and associated odds ratios with the base level.

```{r echo=FALSE}
write_tab <- function(dat, group_var){
  fmla <- paste0("Survived ~ ", group_var)

  mdl_obj <- glm(as.formula(fmla), data = dat, family = "binomial") %>%
    tidy() %>%
    mutate(term = str_remove(term, group_var), OR = exp(estimate)) %>% 
    filter(term != "(Intercept)") %>%
    select(term, OR)

  dat %>%
  group_by(!!sym(group_var)) %>%
  summarise(
    Lived = sum(if_else(Survived == "Yes", 1, 0)),
    Died = sum(if_else(Survived == "No", 1, 0)),
    N = Lived + Died,
    Surv = Lived / N,
    Odds = Surv / (1 - Surv) 
  ) %>%
  ungroup() %>%
  rename(term = !!sym(group_var)) %>%
  mutate(term = as.character(term), Surv = Surv * 100) %>%
  left_join(mdl_obj, by = "term") %>%
  select(term, N, Surv, Odds, OR) %>%
  flextable::flextable() %>% 
  flextable::colformat_int(j = 2) %>% 
  flextable::colformat_num(j = 3, digits = 0, suffix = "%") %>%
  flextable::colformat_num(j = c(4:5)) %>%
  flextable::set_caption(fmla)
}

write_tab(full[train_index, ], group_var = "Sex")

write_tab(full[train_index, ], group_var = "Title")

write_tab(full[train_index, ], group_var = "Pclass")

write_tab(full[train_index, ], group_var = "Embarked")
```


# Linearity

For linear models like logistic regression, the relationship between the numeric predictors and the log survival odds should be linear.  Look closely at these relationships and see if any transformations might help create linearity.

The conclusions from this section are:

* Define an `AgeCohort` predictor for age bins (<16, 16-48, >48).  For linear models, `AgeCohort` should interact with `Age` and `Sex` as `Age*Sex*AgeCohort`.

* It may help to model an interaction with `Sex` and `FamSize`, and with `Sex` and `NetSurv`.

Define handy functions for this analysis.

```{r}

```

## Age

There is a large interaction between sex and age.  Until around age 16, female survival odds increase while males decrease.  From 16 to around 48, survival odds are stable for both sexes.  But after age 48, female survival odds increase while male survival odds decrease. Maybe I should model a 3-way interaction of sex, age, and age cohort (<16, 16-48, >48).

```{r}
fmla = "Survived ~ Sex*AgeCohort*Age"
full <- full %>%
  mutate(
    AgeCohort = case_when(
      Age <= 16 ~ "(0-16)",
      Age <= 48 ~ "(16-48]",
      TRUE ~ "(48-80]"
    ),
    AgeCohort = factor(AgeCohort)
  ) 
dat <- full[train_index, ] %>% mutate(AgeBin = cut(Age, breaks = 20, dig.lab = 2))
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "AgeBin", fmla = fmla)
summary(mdl)
```


## SibSp

Males traveling without a spouse or siblings seemed to have a rough go of it.  Otherwise, the odds of survival seemed to fall with increasing numbers of spouse + siblings.  It may help to model an interaction with Sex and family size.

```{r}
fmla = "Survived ~ Sex + SibSp + FamSize*Sex"
dat <- full[train_index, ] 
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "SibSp", fmla = fmla)
summary(mdl)
```

## Parch

Males traveling without parents or children seemed to have a rough go of it.  Otherwise, the odds of survival seemed to fall with increasing numbers of parents and children.  The interaction with Sex and family size `FamSize` seems to capture this well enough.

```{r}
fmla = "Survived ~ Sex + Parch + FamSize*Sex"
dat <- full[train_index, ]
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "Parch", fmla = fmla)
summary(mdl)
```

## FarePerPass

Survival odds seem to increase with ticket price per passenger with no interaction effects.

```{r}
fmla = "Survived ~ Sex + FarePerPass"
dat <- full[train_index, ] %>% mutate(FareBin = cut(FarePerPass, breaks = 20, dig.lab = 2))
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "FareBin", fmla = fmla)
summary(mdl)
```

## NetSurv

There seems to be a small interaction effect between sex and net survivors.

```{r}
fmla = "Survived ~ Sex*NetSurv"
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "NetSurv", fmla = fmla)
summary(mdl)
```



# Save Work

Another look at the data.  I've added one variable to the data set (`AgeCohort`).

```{r}
skimr::skim(full)
```

```{r}
save(full, train_index, file = "./titanic_02.RData")
```

