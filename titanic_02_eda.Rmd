---
title: "Kaggle - Titanic"
subtitle: "Step 2: Exploratory Analysis"
author: "Michael Foley"
date: "5/7/2020"
output: 
  html_document:
    theme: flatly
    toc: true
    highlight: haddock
    fig_width: 9
    fig_caption: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This is a survey of the Titanic data.  The univariate analysis characterizes the predictor distributions.  The bivariate analysis characterizes relationships among the predictors and with the response variable.  The influential outliers analysis searches for problematic observations.  

Conclusions:

* Factor variables `Employee`, `Deck.A`, and `Title.Master` have near-zero-variance.

* Nearly all of the quantitative predictors suffer from skew.  It may make sense to transform these variables in modeling, especially for linear regression models.

* `Sex` is by the far the best predictor of survival.  `Title` is second, but recall that it basically combines sex and age. `Pclass` is third. 

* Define an `AgeCohort` predictor for age bins (<16, 16-48, >48).  For linear models, `AgeCohort` should interact with `Age` and `Sex` as `Age*Sex*AgeCohort`. Linear models may also benefit from an interaction between `Sex` and `FamSize`, and between `Sex` and `NetSurv`.


# Setup

```{r message=FALSE}
library(tidyverse)
library(caret)  # for nearZeroVar()
library(e1071)  # for skewness()
library(broom)  # for tidy()
library(GGally) # for ggpairs()
library(gridExtra) 
```


# Load Data

The initial data management created the data set `full`, with training rows indexed by `train_index`.

```{r warning=FALSE, message=FALSE}
load("./titanic_01.RData")

glimpse(full)
```

# Univariate Analysis

In this section I will look at data distributions. For factor variables, I am interested in which have near-zero-variance. For quantitative variables, I am looking for significant skew. 

It will be handy to classify the predictors by data type.

```{r}
preds <- full %>% 
  select(-Survived, -PassengerId, -Surname, -Name, -Ticket, -Cabin, -Fare) %>% 
  colnames()
preds_class <- full[, preds] %>% map(class) %>% unlist()
preds_factor <- subset(preds_class, preds_class == "factor") %>% names()
preds_numeric <- subset(preds_class, preds_class %in% c("numeric", "integer")) %>% names()
mdl_vars <- c("Survived", preds)
rm(preds_class)

assertthat::are_equal(length(c(preds_factor, preds_numeric)), length(preds))
```

## Factor Variables

Inspect each factor variable, looking for near-zero-variance (NZV). I might remove them in the modeling pre-process step to prevent zero-variance in CV folds. `caret::nearZeroVar()` defines NZV as a frequency ratio of the most common value to the second most common value frequency >= 19/5 and a unique value percentage <= 10%. (*DataCamp course Machine Learning Toolbox suggests more aggressive thresholds of frequency ratio >= 2 and unique value percentage <= 20%*).

```{r warning=FALSE}
dummies <- dummyVars(~., data = full[, preds_factor], fullRank = FALSE)
dummy_dat <- as.data.frame(predict(dummies, full[, preds_factor]))
(nzv <- dummy_dat %>%
    nearZeroVar(saveMetrics= TRUE)
)
```

The problematic predictors are `Title = "Master"`, `Employee`, and `Deck = "A"`. 

Here is a visualization of the data. Ideally, you want the vars to land in the top left quadrant.  NZV are in the lower right quadrant.

```{r}
nzv %>%
  data.frame() %>% rownames_to_column(var = "col") %>%
  separate(col, sep = "\\.", into = c("col", "level"), ) %>%
  filter(!is.na(level)) %>%
  ggplot(aes(x = freqRatio, y = percentUnique, 
             color = fct_rev(factor(nzv, labels = c("(okay)", "NZV"))), 
             label = level)) +
  geom_text(check_overlap = TRUE, size = 2, na.rm = TRUE) +
  geom_point(size = 3, alpha = 0.6, na.rm = TRUE) +
  geom_hline(yintercept = 10, linetype = "dashed") +
  geom_vline(xintercept = 95/5, linetype = "dashed") +
  theme(legend.position = "top") +
  labs(title = "Near-Zero Variance of Factor Variables", color = "") +
  facet_wrap(~col)

rm(dummies, dummy_dat, nzv)
```


## Quantitative Variables

Skew can contribute to violation of linearity in linear regressions. Iâ€™ll check which variables have significant skew. Skew between 0.5 and 1.0 is generally considered moderate, and skew greater than 1 severe. In the following charts, negligibly skewed predictors are colored theil (there are none), moderately skewed predictors are colored gold and the severely skewed predictors are colored red.

```{r message=FALSE}
col_skew <- map(full[, preds_numeric], skewness) %>% unlist()
col_skew_is_mod <- names(col_skew[abs(col_skew) > .5 & abs(col_skew) <= 1.0])
col_skew_is_high <- names(col_skew[abs(col_skew) > 1.0])
p <- map(
  colnames(full[, preds_numeric]),
  ~ ggplot(full, aes_string(x = .x)) +
    geom_histogram(fill = case_when(.x %in% col_skew_is_mod ~ "goldenrod", 
                                    .x %in% col_skew_is_high ~ "orangered4",
                                    TRUE ~ "cadetblue")) +
    labs(y = "", x = "", title = .x) +
    theme(axis.text.y=element_blank(), plot.title = element_text(size = 10))
)
exec(grid.arrange, ncol = 2, !!!p)

rm(col_skew, col_skew_is_high, col_skew_is_mod)
```

Nearly all of the quantitative predictors suffer from skew.  It may make sense to transform these variables in modeling.

# Bivariate Analysis

In this section I will look at inter-variable relationships. For factor variables, I am interested in which levels have significantly different log survival odds. For quantitative variables, I am looking for linear relationships with log survival odds and low correlations with each other.

Conclusions:

* `Sex` moderates `Pclass`, `Title`, `Embarked`, and `FamSize`.
* `Deck` has very little separation among the levels - collapse it?


Before I begin, let's see what variables are correlated with survival.

```{r cache=TRUE}
dummies_fullrank <- dummyVars(~., data = full[, mdl_vars], fullRank = TRUE)
full_dum <- as.data.frame(predict(dummies_fullrank, full[, mdl_vars]))

cor_out <- full_dum[train_index, ] %>% cor()
cor_out[, "Survived.Yes"] %>% abs() %>% sort(decreasing = TRUE) %>% head(11)
```
 
`Sex` is by the far the best predictor of survival.  `Title` is second, but recall that it basically combines sex and age. `Pclass` is third.  The next best predictors are numeric: `NetSurv`, `FarePerPass`, `Fare`, and `TktSize`.  No surprises here - you're best bet for survival is to be a rich woman.  

```{r}
plot_surv_grp <- function(dat, x_grp, facet_grp){
  dat %>%
  group_by(!!sym(facet_grp), !!sym(x_grp)) %>%
  summarize(n = n(), pct_surv = sum(if_else(Survived == "Yes", 1, 0)) / n()) %>%
  mutate(logodds = round(pct_surv / (1 - pct_surv), 1)) %>%
  ggplot(aes(x = !!sym(x_grp), y = logodds, label = logodds)) + 
  geom_point(aes(color = n), size = 5) +
  geom_text(size = 3, position = position_nudge(y = -1)) +
  scale_color_steps(low = "goldenrod1", high = "goldenrod4") +
  scale_y_continuous(labels = scales::number) +
  labs(
    title = paste0("LogOdds(Survived) ~ ", x_grp, " and ", facet_grp), 
    y = ""
  ) +
  facet_wrap(facets = facet_grp)
}

model_bin <- function(dat, fmla) {
  mdl <- train(
    as.formula(fmla),
    dat,
    method = "glm", family = "binomial",
    metric = "Accuracy",
    trControl = trainControl(method = "cv", n = 10)      
  )
}

plot_bin <- function(dat, x_var, facet_var, fmla) {
  dat %>% 
    group_by(!!sym(x_var), !!sym(facet_var), Survived, pred) %>%
    summarize(n = n()) %>%
    ungroup() %>% 
    group_by(!!sym(x_var), !!sym(facet_var)) %>% 
    mutate(
      N = sum(n), 
      prop = n / N,
      odds = prop / (1 - prop),
      log_odds = log(odds),
      pred_log_odds = log(pred / (1 - pred))
    ) %>%
    filter(Survived == "Yes") %>%
    ggplot(aes(x = !!sym(x_var))) +
      geom_point(aes(y = log_odds, size = N), alpha = 0.6, color = "cadetblue") +
      geom_point(aes(y = pred_log_odds), color = "goldenrod") +
      theme(axis.text.x = element_text(angle = 90)) +
#      scale_y_continuous(limits = c(-3.5, 3.5)) +
      labs(title = fmla, x = x_var) +
      facet_wrap(facets = facet_var)
}
```

## Survived ~ Factor Predictor Relationships

Here are the survival rates grouped by the predictor variables.  I'm faceting by `Sex` because I know already the genders experienced different outcomes.  Which levels differ from others?  Do levels interact with `Sex`?

Useful plot function.
```{r}
plot_bv_bar <- function(dat, fct_var) {
  dat %>%
    count(!!sym(fct_var), Sex, Survived) %>%
    ungroup() %>%
    group_by(!!sym(fct_var), Sex) %>%
    mutate(pct = paste0(scales::percent(n / sum(n)), " (", n, ")")) %>%
    ggplot(aes(x = !!sym(fct_var), y = n, fill = Survived, label = pct)) +
    geom_col() +
    geom_text(position = position_stack(vjust = .5), size = 3) +
    scale_fill_manual(values = c("#c47179", "#a4e6f4")) +
#    theme(legend.position = "bottom") +
    labs(title = paste0("Survived ~ ", fct_var), x = "") +
    facet_wrap(~ Sex)
}
```

Third class passengers (`Pclass = 3`) had a rough go of it.  Male survival odds are cut in half when dropping to 2nd class, then stay about the same for 3rd class.  Female survival odds stayed the same for 2nd class, but halved when dropping to 3rd class.  N-size is small for the females though.  Looks like all three classes are important, but should be moderated by `Sex`.

```{r}
fmla <- "Survived ~ Pclass*Sex*AgeCohort"
dat <- full[train_index, ]
mdl <- full[train_index, ] %>% model_bin(fmla)
dat$pred <- mdl$finalModel$fitted.values  
plot_bin(dat, x_var = "Pclass", facet_var = "Sex", fmla = fmla)
```


```{r}
full[train_index, ] %>% 
  
  plot_surv_grp("Pclass", "Sex")
```


```{r}
plot_bv_bar(full[train_index, ], "Pclass")
```

`Title` is mostly a combination of `Age` and `Sex`.  The survival rates for females do not change by title, but title is important for the males.  If `Title` is in the model, it should interact with `Sex`.

```{r}
plot_bv_bar(full[train_index, ], "Title")
```

Embarking from Queenstown was a death sentence for males.  The port didn't have a strong effect for females.  `Embarked` should interact with `Sex.
```{r}
plot_bv_bar(full[train_index, ], "Embarked")
```

Employee has such a small n-size that it may not be a very useful variable. No females were employees.
```{r}
plot_bv_bar(full[train_index, ], "Employee")
```

Generally, it's better to have a cabin on a deck at the top of the alphabet.  No interaction with `Sex`.  Not a lot of separation among the decks, except maybe decks E & F vs others.  Deck A has a very low n-size.  Consider collapsing `Deck`.
```{r}
plot_bv_bar(full[train_index, ], "Deck")
```

Traveling alone was deadly for males, not so much for females.  Good case for an interaction effect.
```{r}
plot_bv_bar(full[train_index, ], "FamSize")
```

`TktSize` captures all travel partners - family members and others.  Survival odds increase when traveling with 2 and 3 others, then falls if gte4.
```{r}
plot_bv_bar(full[train_index, ], "TktSize")
```

Maybe a good way to capture this is 

```{r}
full[train_index, ] %>%
  count(TicketN, Sex, Survived) %>%
  ggplot(aes(x = TicketN, y = n, fill = Survived)) + geom_col() + facet_wrap(~Sex)
```


```{r}
dat <- full[train_index, ] %>%
  count(Ticket, Sex) %>%
  pivot_wider(names_from = "Sex", values_from = "n", names_prefix = "TicketN") %>%
  replace_na(list(TicketNfemale = 0, TicketNmale = 0))
full[train_index, ] %>%
  left_join(dat, by = "Ticket") %>%
  mutate(TktSexM = TicketNmale - if_else(Sex == "M", 1, 0),
         TktSexF = TicketNfemale - if_else(Sex == "F", 1, 0)) %>%
  select(-TicketNfemale, -TicketNfemale) %>%
  count(Sex, TktSexM, TktSexF, Survived) %>%
  pivot_longer(cols = c(TktSexM, TktSexF), names_to = "TktSex", values_to = "TktSexN") %>%
  filter(Sex == "female") %>%
  ggplot(aes(x = TktSexN, y = n, fill = Survived)) + geom_col() + facet_wrap(~TktSex)
```



## Survived ~ Numeric Predictor Relationships
## Strength in Numbers?

### Family Size
The number of siblings plus spouse on board, `SibSp`, and number of parents and children on board, `Parch` present interesting possibilities.  Does *total* family size improve survival odds? 



In general, survival odds fall with increasing family size, although the n-size is pretty small for families over three.  Men buck the trend a little - their surivorship is relatively low when traveling alone.  I'll make family size a factor variable, `FamSize`, with bins 1, 2, and 3+.  For modeling, it probably makes sense to have an interaction variable for `Title*Fsize`.

```{r}
full <- full %>%
  mutate(
    FamSize = if_else(SibSp + Parch + 1 >=3, 3, SibSp + Parch + 1),
    FamSize = factor(FamSize, levels = c(1, 2, 3), labels = c("1", "2", "gte3"))
  )

full[train_index, ] %>% plot_surv_grp("FamSize", "Title")
```

### Ticket Size

Is there a similar effect for the number of people in the party?

```{r}
full[train_index, ] %>% plot_surv_grp("TicketN", "Title")
```

In general, survival increase until party size of 4, then falls with increasing family size, although the n-size is pretty small for families over three.  Men buck the trend a little - their survivor odds are relatively low when traveling alone.  I'll make family size a factor variable, `Fsize`, with bins 1, 2, and 3+.  For modeling, it probably makes sense to have an interaction variable for `Title*Fsize`.

```{r}
full <- full %>% 
  mutate(
    TktSize = if_else(TicketN >= 4L, 4L, TicketN),
    TktSize = factor(TktSize, levels = c(1, 2, 3, 4), labels = c("1", "2", "3", "gte4"))
  )

full[train_index, ] %>% plot_surv_grp("TktSize", "Title")
```


## Net Survivors

Is the survivorship of the other passengers on the ticket predictive of your survivorship?  Create feature `TicketSurvN`.

```{r}
full <- full %>%
  group_by(Ticket) %>%
  mutate(
    SurvN = sum(Survived == "Yes", na.rm = TRUE),
    PrshN = sum(Survived == "No", na.rm = TRUE)
  ) %>% 
  ungroup() %>%
  mutate(
    SurvN = SurvN - if_else(!is.na(Survived) & Survived == "Yes", 1, 0),
    PrshN = PrshN - if_else(!is.na(Survived) & Survived == "No", 1, 0),
    NetSurv = SurvN - PrshN,
  ) %>%
  select(-SurvN, -PrshN)
```

```{r warning=FALSE, message=FALSE}
plot_net_surv <- function() {
  full[train_index, ] %>%
    group_by(NetSurv, Sex) %>%
    summarize(
      n = n(), 
      log_odds = log(mean(Survived == "Yes") / (1 - mean(Survived == "Yes")))
    ) %>%
    ggplot(aes(x = NetSurv, y = log_odds, color = Sex)) +
    geom_point(aes(size = n)) +
    geom_smooth(se = FALSE, method = "lm") +
    theme_minimal() +
    scale_color_brewer(palette = "Paired") +
    theme(legend.position = "top") +
    labs(title = "Survival log-odds if Others Survive", color = "")
}
plot_net_surv()
```

It certainly does appear to be predictive.  The tails are thinly populated and the linearity breaks down.  I can probably collapse the tails.

```{r}
full[train_index, ] %>% group_by(NetSurv) %>% summarize(n = n(), mean = mean(Survived == "Yes"))
```

I'll collapse bins [-6, -1] and [1, 3].

```{r}
full$NetSurv <- map_dbl(full$NetSurv, max, -1)
full$NetSurv <- map_dbl(full$NetSurv, min, 1)
plot_net_surv()
```


## Numeric Predictor Intervariable Correlations

What are the correlations of the numeric variables with log survival odds?

```{r}

```



Here is a visualization of the relationships.


```{r}
ggpairs(
  full[train_index, c("Survived", preds_numeric)],
  mapping = aes(color = Survived, alpha = 0.02),
  columns = 2:(length(preds_numeric) + 1)
)
```


```{r message=FALSE}
plot_ggpairs <- function(col) {
full[train_index, mdl_vars] %>% 
  ggpairs(
    mapping = aes(color = Survived, alpha = 0.2), 
    columns = c(4, col),
    legend = c(1,1)
  ) +
  theme(legend.position = "top")
}
for(i in c(2, 3, 5:15)) {
  print(plot_ggpairs(i))
}
```


```{r}
plot_bv_box <- function(dat, num_var, color){
  dat %>% 
    ggplot(aes(y = !!sym(num_var)))
}
```

The following tables break down the factor levels and associated odds ratios with the base level.

```{r echo=FALSE}
write_tab <- function(dat, group_var){
  fmla <- paste0("Survived ~ ", group_var)

  mdl_obj <- glm(as.formula(fmla), data = dat, family = "binomial") %>%
    tidy() %>%
    mutate(term = str_remove(term, group_var), OR = exp(estimate)) %>% 
    filter(term != "(Intercept)") %>%
    select(term, OR)

  dat %>%
  group_by(!!sym(group_var)) %>%
  summarise(
    Lived = sum(if_else(Survived == "Yes", 1, 0)),
    Died = sum(if_else(Survived == "No", 1, 0)),
    N = Lived + Died,
    Surv = Lived / N,
    Odds = Surv / (1 - Surv) 
  ) %>%
  ungroup() %>%
  rename(term = !!sym(group_var)) %>%
  mutate(term = as.character(term), Surv = Surv * 100) %>%
  left_join(mdl_obj, by = "term") %>%
  select(term, N, Surv, Odds, OR) %>%
  flextable::flextable() %>% 
  flextable::colformat_int(j = 2) %>% 
  flextable::colformat_num(j = 3, digits = 0, suffix = "%") %>%
  flextable::colformat_num(j = c(4:5)) %>%
  flextable::set_caption(fmla)
}

write_tab(full[train_index, ], group_var = "Sex")

write_tab(full[train_index, ], group_var = "Title")

write_tab(full[train_index, ], group_var = "Pclass")

write_tab(full[train_index, ], group_var = "Embarked")
```


# Linearity

For linear models like logistic regression, the relationship between the numeric predictors and the log survival odds should be linear.  Look closely at these relationships and see if any transformations might help create linearity.

The conclusions from this section are:

* Define an `AgeCohort` predictor for age bins (<16, 16-48, >48).  For linear models, `AgeCohort` should interact with `Age` and `Sex` as `Age*Sex*AgeCohort`.

* It may help to model an interaction with `Sex` and `FamSize`, and with `Sex` and `NetSurv`.

Define handy functions for this analysis.

```{r}

```

## Age

There is a large interaction between sex and age.  Until around age 16, female survival odds increase while males decrease.  From 16 to around 48, survival odds are stable for both sexes.  But after age 48, female survival odds increase while male survival odds decrease. Maybe I should model a 3-way interaction of sex, age, and age cohort (<16, 16-48, >48).

```{r}
fmla = "Survived ~ Sex*AgeCohort*Age"
full <- full %>%
  mutate(
    AgeCohort = case_when(
      Age <= 16 ~ "(0-16)",
      Age <= 48 ~ "(16-48]",
      TRUE ~ "(48-80]"
    ),
    AgeCohort = factor(AgeCohort)
  ) 
dat <- full[train_index, ] %>% mutate(AgeBin = cut(Age, breaks = 20, dig.lab = 2))
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "AgeBin", fmla = fmla)
summary(mdl)
```


## SibSp

Males traveling without a spouse or siblings seemed to have a rough go of it.  Otherwise, the odds of survival seemed to fall with increasing numbers of spouse + siblings.  It may help to model an interaction with Sex and family size.

```{r}
fmla = "Survived ~ Sex + SibSp + FamSize*Sex"
dat <- full[train_index, ] 
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "SibSp", fmla = fmla)
summary(mdl)
```

## Parch

Males traveling without parents or children seemed to have a rough go of it.  Otherwise, the odds of survival seemed to fall with increasing numbers of parents and children.  The interaction with Sex and family size `FamSize` seems to capture this well enough.

```{r}
fmla = "Survived ~ Sex + Parch + FamSize*Sex"
dat <- full[train_index, ]
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "Parch", fmla = fmla)
summary(mdl)
```

## FarePerPass

Survival odds seem to increase with ticket price per passenger with no interaction effects.

```{r}
fmla = "Survived ~ Sex + FarePerPass"
dat <- full[train_index, ] %>% mutate(FareBin = cut(FarePerPass, breaks = 20, dig.lab = 2))
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "FareBin", fmla = fmla)
summary(mdl)
```

## NetSurv

There seems to be a small interaction effect between sex and net survivors.

```{r}
fmla = "Survived ~ Sex*NetSurv"
mdl <- model_bin(dat, fmla)
dat$p <- mdl$finalModel$fitted.values  
plot_bin(dat, x = "NetSurv", fmla = fmla)
summary(mdl)
```



# Save Work

Another look at the data.  I've added one variable to the data set (`AgeCohort`).

```{r}
skimr::skim(full)
```

```{r}
save(full, train_index, file = "./titanic_02.RData")
```

